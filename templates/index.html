<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GradeView • GPA Infrastructure</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        :root {
            --accent: #635bff;
            --accent-hover: #4d43f0;
            --text-main: #0a2540;
            --text-muted: #425466;
            --bg-color: #f6f9fc;
            --surface: #ffffff;
            --success: #0570de; /* Stripe-like blue/green for success */
            --danger: #df1b41;
            --border: #e6ebf1;
            --shadow-sm: 0 2px 5px rgba(50, 50, 93, 0.1), 0 1px 1px rgba(0, 0, 0, 0.04);
            --shadow-md: 0 13px 27px -5px rgba(50, 50, 93, 0.25), 0 8px 16px -8px rgba(0, 0, 0, 0.3);
            --shadow-lg: 0 50px 100px -20px rgba(50, 50, 93, 0.25), 0 30px 60px -30px rgba(0, 0, 0, 0.3);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background-color: var(--bg-color);
            color: var(--text-main);
            line-height: 1.5;
            -webkit-font-smoothing: antialiased;
        }

        /* Stripe-like Gradient Mesh Background */
        .stripe-bg {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 600px;
            background-color: #ffffff;
            background-image: 
                radial-gradient(at 80% 0%, hsla(189,100%,56%,1) 0px, transparent 50%),
                radial-gradient(at 0% 50%, hsla(355,100%,93%,1) 0px, transparent 50%),
                radial-gradient(at 80% 50%, hsla(340,100%,76%,1) 0px, transparent 50%),
                radial-gradient(at 0% 100%, hsla(22,100%,77%,1) 0px, transparent 50%),
                radial-gradient(at 80% 100%, hsla(242,100%,70%,1) 0px, transparent 50%),
                radial-gradient(at 0% 0%, hsla(343,100%,76%,1) 0px, transparent 50%);
            z-index: -1;
            transform: skewY(-6deg);
            transform-origin: top left;
            overflow: hidden;
        }
        
        .stripe-bg::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(255,255,255,0.3);
            backdrop-filter: blur(60px);
        }

        .app-wrapper {
            max-width: 1080px;
            margin: 0 auto;
            padding: 0 20px;
            position: relative;
        }

        /* Navigation */
        .top-nav {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 20px 0;
            margin-bottom: 60px;
        }

        .brand {
            font-weight: 800;
            font-size: 24px;
            color: var(--text-main);
            letter-spacing: -0.5px;
        }

        .brand span {
            color: var(--accent);
        }

        .nav-links {
            display: flex;
            gap: 30px;
            background: rgba(255, 255, 255, 0.8);
            padding: 8px 24px;
            border-radius: 50px;
            backdrop-filter: blur(10px);
            box-shadow: var(--shadow-sm);
        }

        .nav-tab {
            background: none;
            border: none;
            font-weight: 600;
            color: var(--text-muted);
            cursor: pointer;
            font-size: 15px;
            transition: color 0.2s;
        }

        .nav-tab:hover, .nav-tab.active {
            color: var(--text-main);
        }

        .nav-actions {
            display: flex;
            align-items: center;
            gap: 16px;
        }

        .ghost-btn {
            background: rgba(255, 255, 255, 0.5);
            border: none;
            padding: 8px 16px;
            border-radius: 20px;
            font-weight: 600;
            color: var(--text-main);
            cursor: pointer;
            transition: background 0.2s;
        }
        
        .ghost-btn:hover {
            background: rgba(255, 255, 255, 0.8);
        }

        /* Hero Section */
        .hero {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 60px;
            align-items: center;
            margin-bottom: 80px;
            padding-top: 40px;
        }

        .hero-content h1 {
            font-size: 56px;
            line-height: 1.1;
            font-weight: 800;
            letter-spacing: -1.5px;
            margin-bottom: 24px;
            color: var(--text-main);
        }

        .hero-content p {
            font-size: 18px;
            color: var(--text-muted);
            margin-bottom: 32px;
            max-width: 480px;
            line-height: 1.6;
        }

        .hero-graphic {
            position: relative;
            perspective: 1000px;
        }

        /* The "A+" Card Design */
        .aplus-card {
            background: white;
            border-radius: 20px;
            padding: 30px;
            width: 320px;
            margin: 0 auto;
            box-shadow: var(--shadow-lg);
            transform: rotateY(-10deg) rotateX(5deg);
            transition: transform 0.3s ease;
            position: relative;
        }

        .aplus-card:hover {
            transform: rotateY(0deg) rotateX(0deg) translateY(-10px);
        }

        .aplus-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 24px;
        }

        .aplus-badge {
            background: #e3f2fd;
            color: #0570de;
            padding: 6px 12px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .aplus-grade {
            font-size: 64px;
            font-weight: 800;
            color: var(--text-main);
            line-height: 1;
            margin-bottom: 8px;
            text-align: center;
        }

        .aplus-label {
            text-align: center;
            color: var(--text-muted);
            font-size: 14px;
            font-weight: 500;
            margin-bottom: 24px;
        }

        .aplus-details {
            border-top: 1px solid var(--border);
            padding-top: 20px;
        }

        .aplus-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 12px;
            font-size: 14px;
        }

        .aplus-row span:first-child {
            color: var(--text-muted);
        }

        .aplus-row span:last-child {
            font-weight: 600;
            color: var(--text-main);
        }

        /* Dashboard Sections */
        .dash-section {
            margin-bottom: 60px;
            animation: fadeIn 0.5s ease-out;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-end;
            margin-bottom: 30px;
        }

        .section-header h2 {
            font-size: 28px;
            font-weight: 700;
            color: var(--text-main);
            letter-spacing: -0.5px;
        }

        .section-header .eyebrow {
            color: var(--accent);
            font-weight: 700;
            text-transform: uppercase;
            font-size: 12px;
            letter-spacing: 1px;
            margin-bottom: 8px;
            display: block;
        }

        /* Cards Grid */
        .grade-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 24px;
        }

        .course-card {
            background: var(--surface);
            border-radius: 16px;
            padding: 24px;
            box-shadow: var(--shadow-sm);
            transition: all 0.2s ease;
            border: 1px solid transparent;
            cursor: pointer;
        }

        .course-card:hover {
            transform: translateY(-4px);
            box-shadow: var(--shadow-md);
            border-color: var(--border);
        }

        .course-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 16px;
        }

        .course-name {
            font-weight: 600;
            font-size: 16px;
            color: var(--text-main);
            line-height: 1.4;
        }

        .course-grade {
            font-size: 24px;
            font-weight: 700;
            color: var(--accent);
            background: #f0f4ff;
            padding: 4px 12px;
            border-radius: 8px;
        }

        /* Assignments */
        .assignments {
            margin-top: 20px;
            padding-top: 20px;
            border-top: 1px solid var(--border);
            display: none;
        }

        .assignments.show {
            display: block;
        }

        .assignment-item {
            display: flex;
            justify-content: space-between;
            padding: 12px 0;
            border-bottom: 1px solid var(--border);
            font-size: 14px;
        }

        .assignment-item:last-child {
            border-bottom: none;
        }

        .assignment-score {
            font-weight: 700;
            color: var(--success);
        }

        /* Login Box */
        .auth-container {
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
            z-index: 1;
        }

        .auth-panel {
            background: var(--surface);
            padding: 48px;
            border-radius: 24px;
            width: 100%;
            max-width: 440px;
            box-shadow: var(--shadow-lg);
        }

        .auth-panel h1 {
            font-size: 28px;
            margin-bottom: 8px;
            color: var(--text-main);
        }

        .input-group {
            margin-bottom: 20px;
        }

        .input-group label {
            display: block;
            font-size: 14px;
            font-weight: 600;
            color: var(--text-muted);
            margin-bottom: 8px;
        }

        .input-group input {
            width: 100%;
            padding: 12px 16px;
            border: 1px solid var(--border);
            border-radius: 8px;
            font-size: 16px;
            transition: border-color 0.2s, box-shadow 0.2s;
        }

        .input-group input:focus {
            outline: none;
            border-color: var(--accent);
            box-shadow: 0 0 0 4px rgba(99, 91, 255, 0.15);
        }

        .primary-btn {
            background: var(--accent);
            color: white;
            border: none;
            padding: 14px 24px;
            border-radius: 8px;
            font-weight: 600;
            font-size: 16px;
            cursor: pointer;
            transition: background 0.2s, transform 0.1s;
            width: 100%;
        }

        .primary-btn:hover {
            background: var(--accent-hover);
            transform: translateY(-1px);
        }

        .hidden {
            display: none !important;
        }

        /* Stats Grid */
        .stats-row {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 24px;
            margin-bottom: 60px;
        }

        .stat-item {
            background: white;
            padding: 20px;
            border-radius: 12px;
            box-shadow: var(--shadow-sm);
            border: 1px solid var(--border);
        }

        .stat-label {
            font-size: 13px;
            font-weight: 600;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 8px;
        }

        .stat-value {
            font-size: 32px;
            font-weight: 800;
            color: var(--text-main);
        }

        /* GPA & Report Card Styles */
        .gpa-panel {
            background: white;
            border-radius: 16px;
            padding: 32px;
            box-shadow: var(--shadow-sm);
            border: 1px solid var(--border);
        }

        .course-checkbox {
            display: flex;
            align-items: center;
            padding: 12px;
            border-bottom: 1px solid var(--border);
        }
        
        .course-checkbox:last-child {
            border-bottom: none;
        }

        .course-checkbox input {
            margin-right: 16px;
            width: 20px;
            height: 20px;
            accent-color: var(--accent);
        }

        .cumulative-display {
            background: var(--text-main);
            color: white;
            padding: 40px;
            border-radius: 20px;
            text-align: center;
            margin-top: 30px;
            box-shadow: var(--shadow-md);
        }

        .cumulative-value {
            font-size: 72px;
            font-weight: 800;
            line-height: 1;
            margin: 16px 0;
            background: linear-gradient(to right, #fff, #a5b4fc);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        @media (max-width: 768px) {
            .hero { grid-template-columns: 1fr; text-align: center; }
            .hero-graphic { display: none; }
            .stats-row { grid-template-columns: 1fr 1fr; }
            .nav-links { display: none; } /* Simplify for mobile for now */
        }
    </style>
</head>
<body>
    <div class="stripe-bg"></div>

    <!-- Login Section -->
    <div id="loginBox" class="auth-container">
        <div class="auth-panel">
            <h1>Sign in to GradeView</h1>
            <p style="color: var(--text-muted); margin-bottom: 32px;">Access your Leander ISD Home Access Center data</p>
            
            <div id="errorMessage" class="error-message" style="color: var(--danger); margin-bottom: 16px; display: none;"></div>
            
            <form id="loginForm">
                <div class="input-group">
                    <label for="username">Username</label>
                    <input type="text" id="username" placeholder="student.name@k12.leanderisd.org" required>
                </div>
                <div class="input-group">
                    <label for="password">Password</label>
                    <input type="password" id="password" placeholder="••••••••" required>
                </div>
                <button type="submit" id="loginBtn" class="primary-btn">Authenticate</button>
                <div id="loginLoading" class="loading hidden" style="text-align: center; margin-top: 16px; color: var(--text-muted);">Connecting to HAC...</div>
            </form>
        </div>
    </div>

    <!-- Main Dashboard -->
    <div id="dashboardShell" class="app-wrapper hidden">
        <nav class="top-nav">
            <div class="brand">Grade<span>View</span></div>
            <div class="nav-links">
                <button class="nav-tab active" data-target="overviewSection">Overview</button>
                <button class="nav-tab" data-target="gpaSection">GPA Simulator</button>
                <button class="nav-tab" data-target="reportCardContainer">Report Card</button>
            </div>
            <div class="nav-actions">
                <span style="font-weight: 600; font-size: 14px;">GPA <span id="navCurrentGPA" style="color: var(--accent);">--</span></span>
                <button class="ghost-btn" onclick="refreshData()" id="refreshBtn">Refresh</button>
                <button class="ghost-btn" onclick="logout()">Sign out</button>
            </div>
        </nav>

        <section id="overviewSection" class="dash-section">
            <section class="hero">
                <div class="hero-content">
                    <h1>Welcome to GradeView</h1>
                    <p>GradeView provides a unified platform to track active cycles, analyze report cards, and forecast your cumulative GPA with real-time data from HAC.</p>
                    <div style="display: flex; gap: 16px;">
                        <button class="primary-btn" style="width: auto;" onclick="document.getElementById('gradesList').scrollIntoView({behavior: 'smooth'})">View Grades</button>
                        <button class="ghost-btn" style="background: white; border: 1px solid var(--border);" onclick="activateSection('gpaSection')">Calculate GPA</button>
                    </div>
                </div>
                <div class="hero-graphic">
                    <div class="aplus-card">
                        <div class="aplus-header">
                            <div style="font-weight: 700; color: var(--text-main);">AP Computer Science A</div>
                            <div class="aplus-badge">Verified</div>
                        </div>
                        <div class="aplus-grade">98</div>
                        <div class="aplus-label">Current Cycle Average</div>
                        <div class="aplus-details">
                            <div class="aplus-row">
                                <span>Class Rank</span>
                                <span>Top 5%</span>
                            </div>
                            <div class="aplus-row">
                                <span>GPA Impact</span>
                                <span style="color: var(--success);">+0.05</span>
                            </div>
                            <div class="aplus-row">
                                <span>Last Updated</span>
                                <span>Just now</span>
                            </div>
                        </div>
                    </div>
                </div>
            </section>

            <div class="stats-row">
                <div class="stat-item">
                    <div class="stat-label">Overall Average</div>
                    <div class="stat-value" id="statOverall">--</div>
                </div>
                <div class="stat-item">
                    <div class="stat-label">Highest Grade</div>
                    <div class="stat-value" id="statHigh">--</div>
                </div>
                <div class="stat-item">
                    <div class="stat-label">Lowest Grade</div>
                    <div class="stat-value" id="statLow">--</div>
                </div>
                <div class="stat-item">
                    <div class="stat-label">Active Courses</div>
                    <div class="stat-value" id="statCourses">--</div>
                </div>
            </div>

            <div id="gradesContainer">
                <div class="section-header">
                    <div>
                        <span class="eyebrow">Live Data</span>
                        <h2>Active Courses</h2>
                    </div>
                </div>
                <div id="gradesList" class="grade-grid"></div>
            </div>
        </section>

        <section id="gpaSection" class="dash-section hidden">
            <div class="section-header">
                <div>
                    <span class="eyebrow">Forecasting</span>
                    <h2>GPA Simulator</h2>
                </div>
            </div>
            <div class="gpa-panel">
                <h3 style="margin-bottom: 20px;">Select Active Courses</h3>
                <div id="courseCheckboxes"></div>
                
                <div style="margin-top: 30px;">
                    <h3 style="margin-bottom: 20px;">So far this year</h3>
                    <div id="pastCyclesDisplay" style="color: var(--text-muted);">Run calculation to fetch data...</div>
                </div>

                <div id="courseExclusionSection" class="hidden" style="margin-top: 30px; padding-top: 20px; border-top: 1px solid var(--border);">
                    <h4 style="margin-bottom: 10px;">Exclude Courses (All Cycles)</h4>
                    <div id="excludedCoursesList"></div>
                </div>

                <button class="primary-btn" style="margin-top: 30px;" onclick="calculateCumulativeGPA()">Run Simulation</button>
            </div>

            <div id="cumulativeGPAResult" class="cumulative-display hidden">
                <div style="font-weight: 600; opacity: 0.8;">CUMULATIVE GPA</div>
                <div id="cumulativeGPAValue" class="cumulative-value">0.00</div>
                <div style="font-size: 14px; opacity: 0.7;">Based on active selections + grades so far this year</div>
            </div>
        </section>

        <section id="reportCardContainer" class="dash-section hidden">
            <div class="section-header">
                <div>
                    <span class="eyebrow">History</span>
                    <h2>Report Cards</h2>
                </div>
            </div>
            <div id="reportCardLoading" class="loading hidden">Fetching report card data...</div>
            <div id="reportCardContent"></div>
            <div id="overallReportGPA" class="cumulative-display hidden">
                <div style="font-weight: 600; opacity: 0.8;">OVERALL REPORT CARD GPA</div>
                <div id="overallReportGPAValue" class="cumulative-value">0.00</div>
            </div>
        </section>
    </div>

    <script>
        let sessionId = localStorage.getItem('sessionId') || null;
        let allGradesData = [];
        let reportCardData = null;

        const dashSections = () => document.querySelectorAll('.dash-section');

        document.querySelectorAll('.nav-tab').forEach(tab => {
            tab.addEventListener('click', () => activateSection(tab.dataset.target));
        });

        if (sessionId) {
            restoreSession();
        }

        async function restoreSession() {
            try {
                const response = await fetch('/api/grades', {
                    headers: { 'X-Session-ID': sessionId }
                });
                if (!response.ok) throw new Error('Session invalid');
                await handleAuthenticatedState();
            } catch (error) {
                sessionId = null;
                localStorage.removeItem('sessionId');
            }
        }

        async function handleAuthenticatedState() {
            await loadGrades();
            // Start fetching report card data in the background
            loadReportCard();
            document.getElementById('loginBox').classList.add('hidden');
            document.getElementById('dashboardShell').classList.remove('hidden');
            activateSection('overviewSection');
        }

        document.getElementById('loginForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;
            const errorDiv = document.getElementById('errorMessage');
            const loginBtn = document.getElementById('loginBtn');
            const loading = document.getElementById('loginLoading');

            errorDiv.style.display = 'none';
            loginBtn.disabled = true;
            loginBtn.textContent = 'Authenticating...';
            loading.classList.remove('hidden');

            try {
                const response = await fetch('/api/login', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ username, password })
                });

                const data = await response.json();
                if (!response.ok) {
                    throw new Error(data.error || 'Login failed');
                }

                sessionId = data.session_id;
                localStorage.setItem('sessionId', sessionId);
                await handleAuthenticatedState();

            } catch (error) {
                errorDiv.textContent = error.message;
                errorDiv.style.display = 'block';
                loginBtn.textContent = 'Authenticate';
            } finally {
                loginBtn.disabled = false;
                loading.classList.add('hidden');
            }
        });

        function activateSection(targetId) {
            const targetEl = document.getElementById(targetId);
            dashSections().forEach(section => {
                section.classList.toggle('hidden', section !== targetEl);
            });
            document.querySelectorAll('.nav-tab').forEach(btn => {
                btn.classList.toggle('active', btn.dataset.target === targetId);
            });
            
            // Scroll to top to simulate page change
            window.scrollTo(0, 0);

            if (targetId === 'gpaSection') {
                prepareGPASection();
            }
            if (targetId === 'reportCardContainer' && !reportCardData) {
                loadReportCard();
            }
        }

        async function refreshData() {
            const btn = document.getElementById('refreshBtn');
            const originalText = btn.textContent;
            btn.disabled = true;
            btn.textContent = 'Refreshing...';
            
            try {
                await loadGrades();
                await loadReportCard();
                alert('Data refreshed successfully');
            } catch (error) {
                alert('Failed to refresh data: ' + error.message);
                if (error.message.includes('Session expired')) {
                    logout();
                }
            } finally {
                btn.disabled = false;
                btn.textContent = originalText;
            }
        }

        async function loadGrades() {
            const response = await fetch('/api/grades', {
                headers: { 'X-Session-ID': sessionId }
            });

            const data = await response.json();
            if (!response.ok) {
                if (response.status === 401) {
                    sessionId = null;
                    localStorage.removeItem('sessionId');
                    throw new Error('Session expired. Please log in again.');
                }
                throw new Error(data.error || 'Failed to load grades');
            }

            allGradesData = data.grades;
            displayGrades(allGradesData);
            updateHeroStats(data);
            await autoCalculateGPA();
        }

        function displayGrades(grades) {
            const gradesList = document.getElementById('gradesList');
            gradesList.innerHTML = '';
            grades.forEach((course, index) => {
                const card = document.createElement('div');
                card.className = 'course-card';
                card.onclick = () => toggleAssignments(index);
                const gpaDisplay = course.gpa ? `<span style="color: var(--text-muted); font-size: 14px; font-weight: 500;">GPA ${course.gpa}</span>` : '';
                card.innerHTML = `
                    <div class="course-header">
                        <div>
                            <div class="course-name">${course.name}</div>
                            ${gpaDisplay}
                        </div>
                        <div class="course-grade">${course.grade}</div>
                    </div>
                    <div id="assignments-${index}" class="assignments"></div>
                `;
                gradesList.appendChild(card);
            });
        }

        function toggleAssignments(index) {
            const assignmentsDiv = document.getElementById(`assignments-${index}`);
            if (!assignmentsDiv) return;
            assignmentsDiv.classList.toggle('show');
            if (assignmentsDiv.classList.contains('show')) {
                const course = allGradesData[index] || {};
                const assignmentList = Array.isArray(course.assignments) ? course.assignments : [];
                displayAssignments(assignmentList, index);
            }
        }

        function displayAssignments(assignments, index) {
            const assignmentsDiv = document.getElementById(`assignments-${index}`);
            if (assignments.length === 0) {
                assignmentsDiv.innerHTML = '<div style="color: var(--text-muted); font-size: 14px;">No assignments found</div>';
                return;
            }
            let html = '';
            assignments.forEach(assignment => {
                html += `
                    <div class="assignment-item">
                        <div style="flex: 1; color: var(--text-muted);">${assignment.date_due}</div>
                        <div style="flex: 2; font-weight: 500;">${assignment.name}</div>
                        <div class="assignment-score">${assignment.score}</div>
                    </div>
                `;
            });
            assignmentsDiv.innerHTML = html;
        }

        function prepareGPASection() {
            const checkboxContainer = document.getElementById('courseCheckboxes');
            checkboxContainer.innerHTML = '';
            const savedCourses = JSON.parse(localStorage.getItem('selectedCourses') || '[]');
            allGradesData.forEach(course => {
                if (course.gpa !== null) {
                    const courseIdKey = String(course.course_id);
                    const isChecked = savedCourses.length === 0 || savedCourses.includes(courseIdKey);
                    const div = document.createElement('div');
                    div.className = 'course-checkbox';
                    div.innerHTML = `
                        <input type="checkbox" id="course-${course.course_id}" value="${courseIdKey}" ${isChecked ? 'checked' : ''} onchange="autoCalculateGPA()">
                        <div style="flex: 1;">
                            <div style="font-weight: 600;">${course.name}</div>
                            <div style="color: var(--text-muted); font-size: 13px;">Current Grade: ${course.grade} (GPA: ${course.gpa})</div>
                        </div>
                    `;
                    checkboxContainer.appendChild(div);
                }
            });
        }

        async function autoCalculateGPA() {
            // Calculate locally using allGradesData and reportCardData
            const checkboxNodeList = document.querySelectorAll('#courseCheckboxes input[type="checkbox"]');
            const selectedCourses = [];
            const savedCourses = JSON.parse(localStorage.getItem('selectedCourses') || '[]');

            if (checkboxNodeList.length) {
                checkboxNodeList.forEach(box => {
                    if (box.checked) {
                        selectedCourses.push(box.value);
                    }
                });
                localStorage.setItem('selectedCourses', JSON.stringify(selectedCourses));
            } else {
                allGradesData.forEach(course => {
                    const courseIdKey = String(course.course_id);
                    if (course.gpa !== null && (savedCourses.length === 0 || savedCourses.includes(courseIdKey))) {
                        selectedCourses.push(courseIdKey);
                    }
                });
            }

            const normalizedSelected = selectedCourses.map(id => {
                const numeric = Number(id);
                return Number.isNaN(numeric) ? id : numeric;
            });
            
            const excludedCourses = JSON.parse(localStorage.getItem('excludedCourses') || '[]');
            
            performLocalGPACalculation(normalizedSelected, excludedCourses);
        }

        function performLocalGPACalculation(selectedCourseIds, excludedCourseNames) {
            let totalGPA = 0;
            let totalCount = 0;
            
            // 1. Current Courses
            allGradesData.forEach(course => {
                // Check if course is selected (using string comparison for IDs)
                if (selectedCourseIds.includes(String(course.course_id)) || selectedCourseIds.includes(course.course_id)) {
                    if (course.gpa !== null) {
                        totalGPA += course.gpa;
                        totalCount++;
                    }
                }
            });

            // 2. Past Cycles (if available)
            let pastCyclesCount = 0;
            let pastCyclesDetail = [];
            let allUniqueCourses = new Set();

            if (reportCardData && reportCardData.cycles) {
                reportCardData.cycles.forEach(cycle => {
                    let cycleCourses = [];
                    let cycleTotalGPA = 0;
                    let cycleCourseCount = 0;

                    cycle.courses.forEach(course => {
                        allUniqueCourses.add(course.course);
                        
                        if (!excludedCourseNames.includes(course.course)) {
                            if (course.gpa !== null) {
                                cycleTotalGPA += course.gpa;
                                cycleCourseCount++;
                                
                                cycleCourses.push({
                                    course_name: course.course,
                                    grade: course.grade,
                                    gpa: course.gpa
                                });
                            }
                        }
                    });

                    if (cycleCourseCount > 0) {
                        const cycleAvg = cycleTotalGPA / cycleCourseCount;
                        // Weight each course individually, not just the cycle average
                        totalGPA += cycleTotalGPA;
                        totalCount += cycleCourseCount;
                        
                        pastCyclesCount++;
                        pastCyclesDetail.push({
                            cycle_name: cycle.cycle_name,
                            courses: cycleCourses,
                            average_gpa: cycleAvg
                        });
                    }
                });
            }

            // Calculate Cumulative
            const cumulativeGPA = totalCount > 0 ? (totalGPA / totalCount) : 0;
            const gpaValue = cumulativeGPA.toFixed(2);
            
            // Update UI
            const navGPA = document.getElementById('navCurrentGPA');
            if (navGPA) navGPA.textContent = gpaValue;
            
            const currentGPA = document.getElementById('currentGPA');
            if (currentGPA) currentGPA.textContent = gpaValue;
            
            const cumulativeValue = document.getElementById('cumulativeGPAValue');
            if (cumulativeValue) cumulativeValue.textContent = gpaValue;

            // Update Past Cycles UI if we are in the full calculation view
            const pastCyclesDiv = document.getElementById('pastCyclesDisplay');
            if (pastCyclesDiv && pastCyclesDiv.textContent !== 'Run calculation to fetch transcript...') {
                 if (reportCardData) {
                    if (pastCyclesCount > 0) {
                        let cycleInfo = `<div style="background: #f0fdf4; padding: 16px; border-radius: 8px; border: 1px solid #bbf7d0; margin-bottom: 16px;">`;
                        cycleInfo += `<strong style="color: #166534;">✓ Retrieved ${pastCyclesCount} past cycles from local data</strong>`;
                        cycleInfo += `</div>`;

                        cycleInfo += `<div style="display: grid; gap: 16px;">`;
                        pastCyclesDetail.forEach(cycle => {
                            cycleInfo += `<div style="background: #f8fafc; padding: 16px; border-radius: 8px; border: 1px solid var(--border);">`;
                            cycleInfo += `<div style="display: flex; justify-content: space-between; margin-bottom: 12px;">`;
                            cycleInfo += `<span style="font-weight: 600; color: var(--text-main);">${cycle.cycle_name}</span>`;
                            cycleInfo += `<span style="font-weight: 700; color: var(--accent);">GPA ${cycle.average_gpa.toFixed(2)}</span>`;
                            cycleInfo += `</div>`;
                            
                            cycle.courses.forEach(course => {
                                cycleInfo += `<div style="display: flex; justify-content: space-between; font-size: 13px; margin-bottom: 4px; color: var(--text-muted);">`;
                                cycleInfo += `<span>${course.course_name}</span>`;
                                cycleInfo += `<span>${course.grade} (${course.gpa.toFixed(2)})</span>`;
                                cycleInfo += `</div>`;
                            });
                            cycleInfo += `</div>`;
                        });
                        cycleInfo += `</div>`;
                        pastCyclesDiv.innerHTML = cycleInfo;
                    } else {
                        pastCyclesDiv.innerHTML = 'No past cycles found in loaded data.';
                    }
                    
                    // Update exclusions list
                    const exclusionSection = document.getElementById('courseExclusionSection');
                    const excludedList = document.getElementById('excludedCoursesList');
                    if (allUniqueCourses.size > 0) {
                        exclusionSection.classList.remove('hidden');
                        let exclusionHTML = '';
                        Array.from(allUniqueCourses).sort().forEach(courseName => {
                            const isExcluded = excludedCourseNames.includes(courseName);
                            exclusionHTML += `
                                <div class="course-checkbox">
                                    <input type="checkbox" id="exclude-${courseName.replace(/\s+/g, '-')}"
                                           value="${courseName}"
                                           ${isExcluded ? 'checked' : ''}
                                           onchange="toggleCourseExclusion('${courseName.replace(/'/g, "\\'")}', this.checked)">
                                    <label for="exclude-${courseName.replace(/\s+/g, '-')}" style="cursor: pointer; flex: 1; font-size: 14px;">
                                        ${courseName}
                                    </label>
                                </div>
                            `;
                        });
                        excludedList.innerHTML = exclusionHTML;
                    }

                 } else {
                     pastCyclesDiv.innerHTML = 'Transcript data is loading...';
                 }
            }
        }

        async function calculateCumulativeGPA() {
            // Just trigger the local calculation and show the UI
            const pastCyclesDiv = document.getElementById('pastCyclesDisplay');
            pastCyclesDiv.textContent = 'Analyzing data...';
            
            document.getElementById('cumulativeGPAResult').classList.remove('hidden');
            document.getElementById('cumulativeGPAResult').scrollIntoView({behavior: 'smooth'});
            
            autoCalculateGPA();
        }

        function toggleCourseExclusion(courseName, isExcluded) {
            let excludedCourses = JSON.parse(localStorage.getItem('excludedCourses') || '[]');
            if (isExcluded) {
                if (!excludedCourses.includes(courseName)) {
                    excludedCourses.push(courseName);
                }
            } else {
                excludedCourses = excludedCourses.filter(c => c !== courseName);
            }
            localStorage.setItem('excludedCourses', JSON.stringify(excludedCourses));
            autoCalculateGPA();
        }

        function logout() {
            sessionId = null;
            allGradesData = [];
            reportCardData = null;
            localStorage.removeItem('sessionId');
            document.getElementById('loginBox').classList.remove('hidden');
            document.getElementById('dashboardShell').classList.add('hidden');
            document.getElementById('loginForm').reset();
        }

        function updateHeroStats(data) {
            const grades = data.grades || [];
            const overall = typeof data.overall_average === 'number' ? data.overall_average : null;
            const numericGrades = grades.map(g => g.numeric_grade).filter(g => typeof g === 'number');
            const highest = numericGrades.length ? Math.max(...numericGrades) : null;
            const lowest = numericGrades.length ? Math.min(...numericGrades) : null;
            
            document.getElementById('statOverall').textContent = overall !== null ? `${overall.toFixed(2)}%` : '--';
            document.getElementById('statHigh').textContent = highest !== null ? `${highest.toFixed(1)}%` : '--';
            document.getElementById('statLow').textContent = lowest !== null ? `${lowest.toFixed(1)}%` : '--';
            document.getElementById('statCourses').textContent = grades.length ? grades.length.toString() : '--';
        }

        async function loadReportCard() {
            const loadingDiv = document.getElementById('reportCardLoading');
            const contentDiv = document.getElementById('reportCardContent');
            const overallGPADiv = document.getElementById('overallReportGPA');
            loadingDiv.classList.remove('hidden');
            contentDiv.innerHTML = '';
            overallGPADiv.classList.add('hidden');
            
            try {
                const response = await fetch('/api/report-card', {
                    headers: { 'X-Session-ID': sessionId }
                });
                const data = await response.json();
                
                if (!response.ok) {
                    throw new Error(data.error || 'Failed to load report card');
                }
                
                loadingDiv.classList.add('hidden');
                reportCardData = data;
                
                if (data.cycles && data.cycles.length > 0) {
                    let html = '';
                    data.cycles.forEach((cycle, idx) => {
                        html += `
                            <div style="background: white; border-radius: 12px; border: 1px solid var(--border); margin-bottom: 20px; overflow: hidden;">
                                <div style="padding: 16px 24px; background: #f8fafc; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center;">
                                    <h3 style="font-size: 16px; font-weight: 600;">${cycle.cycle_name}</h3>
                                    <span style="font-weight: 700; color: var(--accent);">Avg GPA ${cycle.average_gpa.toFixed(2)}</span>
                                </div>
                                <div style="padding: 16px 24px;">
                        `;
                        cycle.courses.forEach(course => {
                            html += `
                                <div style="display: flex; justify-content: space-between; padding: 12px 0; border-bottom: 1px solid var(--border);">
                                    <div>
                                        <div style="font-weight: 600;">${course.course}</div>
                                        <div style="font-size: 12px; color: var(--text-muted);">${course.course_code}</div>
                                    </div>
                                    <div style="text-align: right;">
                                        <div style="font-weight: 700; color: var(--text-main);">${course.grade}</div>
                                        <div style="font-size: 12px; color: var(--text-muted);">GPA ${course.gpa.toFixed(2)}</div>
                                    </div>
                                </div>
                            `;
                        });
                        html += '</div></div>';
                    });
                    contentDiv.innerHTML = html;
                    
                    const overallGpaValue = typeof data.overall_gpa === 'number' ? data.overall_gpa.toFixed(2) : '--';
                    document.getElementById('overallReportGPAValue').textContent = overallGpaValue;
                    overallGPADiv.classList.remove('hidden');
                } else {
                    contentDiv.innerHTML = '<p style="text-align:center; padding: 24px;">No report card data available.</p>';
                }
            } catch (error) {
                loadingDiv.classList.add('hidden');
                contentDiv.innerHTML = `<p style="text-align:center; color: var(--danger); padding: 24px;">Error: ${error.message}</p>`;
            }
        }
    </script>
</body>
</html>
